---
- name: Create namespace
  kubernetes.core.k8s:
    template:
      - path: templates/ns.yml.j2

- name: MariaDB Update
  register: mariadb_pwd
  # use "ansible.builtin.shell" for pipeable commands
  ansible.builtin.shell: |
    set -o pipefail
    kubectl get secret matomo-mariadb -n {{ k8s__matomo_namespace }} -o jsonpath="{.data.mariadb-root-password}" | base64 -d
  failed_when: false # replacement for ignore_errors
  changed_when: mariadb_pwd.rc != 0

###

- name: Add stable chart repo
  kubernetes.core.helm_repository:
    name: bitnami
    repo_url: https://charts.bitnami.com/bitnami

- name: Install Matomo Stack w/ Helm
  kubernetes.core.helm:
    name: matomo
    chart_ref: bitnami/matomo
    release_namespace: "{{ k8s__matomo_namespace }}"
    create_namespace: false
    wait: true
    values:
      volumePermissions:
        enabled: true
      podLabels:
        app: matomo
      mariadb:
        auth:
          rootPassword: "{{ mariadb_pwd.stdout | default('') }}"
      matomoUsername: "{{ matomo__admin_username }}"
      matomoPassword: "{{ matomo__admin_password }}"
      matomoEmail: "{{ iac__postmaster_email }}"
      matomoWebsiteName: Matomo
      matomoWebsiteHost: https://{{ k8s__matomo__external_hostname }}
      #
      smtpAuth: Login
      smtpHost: "{{ docker_mailserver__internal_smtp_server }}"
      smtpPort: "{{ docker_mailserver__internal_smtp_preferred_port }}"
      smtpUser: "{{ iac__donotreply_username }}"
      smtpPassword: "{{ iac__donotreply_password }}"
      smtpProtocol: tls
      noreplyName: "{{ iac__donotreply_name }}"
      noreplyAddress: "{{ iac__donotreply_email }}"
      #
      ingress:
        enabled: true
        hostname: "{{ k8s__matomo__external_hostname }}"
        annotations:
          #
          external-dns.alpha.kubernetes.io/hostname: "{{ k8s__matomo__external_hostname }}"
          external-dns.alpha.kubernetes.io/cloudflare-proxied: "true"
          #
          ingress-dashboard/title: Matomo
          ingress-dashboard/description: Tracks stats on our organization public websites
          ingress-dashboard/logo-url: /favicon.ico
          ingress-dashboard/assume-tls: "true"
          ingress-dashboard/hide: "false"

###

- name: Mount locally PVC
  ansible.builtin.include_role:
    name: utilities__longhorn
    tasks_from: mount-pvc
  vars:
    utilities__longhorn__mount_pvc__namespace: "{{ k8s__matomo_namespace }}"
    utilities__longhorn__mount_pvc__name: matomo-matomo

- name: Wait until the config file exist
  ansible.builtin.wait_for:
    path: "{{ iac__utilities__longhorn_mount_path }}/config/config.ini.php"

- name: Edit ini
  community.general.ini_file:
    path: "{{ iac__utilities__longhorn_mount_path }}/config/config.ini.php"
    section: General
    no_extra_spaces: true
    option: assume_secure_protocol
    values: "1"
    mode: "0775"

- name: Unmount PVC
  ansible.builtin.include_role:
    name: utilities__longhorn
    tasks_from: unmount-pvc
