---
- name: Install server definitions
  kubernetes.core.k8s:
    template:
      - path: templates/ns.yml.j2
      - path: templates/serverdefs-secret.yml.j2

- name: Add stable chart repo
  kubernetes.core.helm_repository:
    name: runix
    repo_url: https://helm.runix.net
    force_update: true

- name: Install pgadmin w/ Helm
  kubernetes.core.helm:
    name: pgadmin
    chart_ref: runix/pgadmin4
    release_namespace: "{{ pgadmin__namespace }}"
    create_namespace: false
    wait: true
    values:
      serverDefinitions:
        enabled: true
        resourceType: Secret
        existingSecret: "{{ pgadmin__serverdef_secret_name }}"
      env:
        email: "{{ pgadmin__username_email }}"
        password: "{{ pgadmin__password }}"
      ingress:
        enabled: true
        hosts:
          - host: "{{ k8s__pgadmin__extername_hostname }}"
            paths:
              - path: /
                pathType: Prefix
        annotations:
          #
          external-dns.alpha.kubernetes.io/hostname: "{{ k8s__pgadmin__extername_hostname }}"
          external-dns.alpha.kubernetes.io/cloudflare-proxied: "true"
          #
          ingress-dashboard/title: PgAdmin
          ingress-dashboard/description: Access postgresql databases
          ingress-dashboard/logo-url: /favicon.ico
          ingress-dashboard/assume-tls: "true"
          ingress-dashboard/hide: "false"
