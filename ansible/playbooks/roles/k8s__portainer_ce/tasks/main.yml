---
- name: Create Persistent Volume dir path
  ansible.builtin.file:
    path: "{{ iac__pv_path__portainer }}"
    state: directory
    mode: "0755"

- name: Define or create Persistent volume
  kubernetes.core.k8s:
    template:
      - path: templates/ns.yml.j2
      - path: templates/pv.yml.j2
      - path: templates/secret.yml.j2

- name: Add stable chart repo Portainer CE
  kubernetes.core.helm_repository:
    name: portainer
    repo_url: https://portainer.github.io/k8s/

- name: Install Zero-Trust configuration
  tags: [zto-app]
  kubernetes.core.k8s:
    template:
      - path: templates/caa.yml.j2

- name: Install Portainer CE w/ Helm
  kubernetes.core.helm:
    name: portainer
    chart_ref: portainer/portainer
    release_namespace: portainer
    create_namespace: false
    values:
      nodeSelector:
        kubernetes.io/hostname: "{{ iac__master_node_name }}"
      persistence:
        storageClass: "{{ iac__local_storage__class_name }}"
      service:
        type: LoadBalancer # https://docs.tigera.io/archive/v3.18/networking/advertise-service-ips#before-you-begin
      tls:
        force: true
        # existingSecret: "portainer-ce-certs"
      ingress:
        enabled: true
        ingressClassName: "{{ iac__ingress_class_name }}"
        annotations:
          #
          cert-manager.io/cluster-issuer: "{{ cert_manager__org__issuer }}"
          #
          nginx.ingress.kubernetes.io/ssl-redirect: "false" # when using Cloudflare's proxied DNS record
          traefik.ingress.kubernetes.io/service.serversscheme: "https"
          #
          external-dns.alpha.kubernetes.io/hostname: "{{ k8s__portainer_ce__external_hostname }}"
          external-dns.alpha.kubernetes.io/cloudflare-proxied: "true"
          #
          ingress-dashboard/title: Portainer
          ingress-dashboard/description: Alternative cluster management dashboard for Docker, Swarm of k8s
          ingress-dashboard/logo-url: /favicon.ico
          ingress-dashboard/assume-tls: "true"
          ingress-dashboard/hide: "false"
        hosts:
          - host: "{{ k8s__portainer_ce__external_hostname }}"
            paths:
              - path: /

- name: Wait for pod to become ready
  ansible.builtin.command: |
    kubectl wait
    pod -l app.kubernetes.io/name=portainer
    --namespace=portainer
    --for=condition=Ready
    --timeout=120s
  register: pods_ready
  changed_when: pods_ready.rc != 0

##
## Password auto-config
##

- name: Load facts
  ansible.builtin.set_fact:
    portainer_pod_args_replace:

#
- name: Patch with admin password
  kubernetes.core.k8s_json_patch:
    kind: Deployment
    namespace: portainer
    name: portainer
    patch:
      - op: replace
        path: /spec/template/spec/volumes
        value:
          - name: admin-pwd
            secret:
              secretName: portainer-admin
      - op: replace
        path: /spec/template/spec/containers/0/volumeMounts
        value:
          - name: admin-pwd
            mountPath: /run/secrets
      - op: replace
        path: /spec/template/spec/containers/0/args
        value:
          - --admin-password-file='/run/secrets/portainer-pass'
