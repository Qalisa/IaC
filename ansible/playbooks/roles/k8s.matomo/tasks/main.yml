---
- name: Create Persistent Volume dir path
  ansible.builtin.file:
    path: "{{ item.path }}"
    # owner: "{{ item.owner }}"
    # group: "{{ item.group }}"
    state: directory
    mode: '0755'
  loop:
    - path: "{{ matomo_pv_db_path }}"
      # owner: 1001
      # group: 1001
    - path: "{{ matomo_pv_app_path }}"
      # owner: 1001
      # group: 0

- name: Prepare volumes manifests
  kubernetes.core.k8s:
    state: present
    template:
      - path: templates/ns.yml.j2
      - path: templates/app/pv.yml.j2
      - path: templates/db/pv.yml.j2
      - path: templates/db/pvc.yml.j2

- name: postgres update
  register: postgres_pwd
  shell: kubectl get secret -n sentry sentry-sentry-postgresql -o jsonpath="{.data.postgres-password}" | base64 -d
  ignore_errors: true

- name: Install Matomo Stack w/ Helm
  kubernetes.core.helm:
    name: matomo
    chart_ref: oci://registry-1.docker.io/bitnamicharts/matomo
    release_namespace: "{{ matomo_namespace }}"
    create_namespace: false
    values:
      global:
        postgresql:
          auth:
            postgresPassword: "{{ postgres_pwd.stdout | default('') }}"
      volumePermissions:
        enabled: true
      podLabels:
        app: matomo
      persistence:
        storageClass: "{{ local_storage_class_name }}"
        selector:
          matchLabels:
            name: matomo-app
      mariadb:
        primary:
          persistence:
            existingClaim: db
      # externalDatabase:
      #   host: "matomo-mariadb.matomo"
      matomoUsername: "{{ matomo_username }}"
      matomoPassword: "{{ matomo_password }}"
      matomoEmail: "{{ postmaster_email }}"
      matomoWebsiteName: Matomo
      matomoWebsiteHost: https://matomo.{{ root_domain }}
      #
      smtpAuth: Login
      smtpHost: docker-mailserver.docker-mailserver
      smtpPort: 587
      smtpUser: "{{ donotreply_username }}"
      smtpPassword: "{{ donotreply_password }}"
      smtpProtocol: tls
      noreplyName: "Do Not Reply"
      noreplyAddress: "{{ donotreply_email }}"

      #
      service:
        type:	LoadBalancer
        externalTrafficPolicy: Local
      ingress:
        enabled: true
        ingressClassName:	"{{ ingress_nginx_class }}"
        hostname:	matomo.{{ root_domain }}
        annotations:
            # when using Cloudflare's proxied DNS record
            nginx.ingress.kubernetes.io/ssl-redirect: "false"
            cert-manager.io/cluster-issuer: "selfsigned"
            nginx.ingress.kubernetes.io/backend-protocol: "HTTP"

- name: Wait for pod to become ready
  ansible.builtin.command: "kubectl wait --namespace=matomo --for=condition=Ready pod -l app=matomo --timeout=120s"
  register: pods_ready
  changed_when: pods_ready.rc != 0

- name: Wait until the config file exist
  ansible.builtin.wait_for:
    path: "{{ matomo_pv_app_path }}/config/config.ini.php"

- name: Edit ini
  community.general.ini_file:
    path: "{{ matomo_pv_app_path }}/config/config.ini.php"
    section: General
    no_extra_spaces: true
    option: assume_secure_protocol
    values: '1'
