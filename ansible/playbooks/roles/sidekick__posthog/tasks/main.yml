---
- name: Clone posthog GH repo to tag
  ansible.builtin.git:
    repo: "{{ sidekick__posthog__github_repo }}"
    version: master
    single_branch: true
    depth: 1
    force: true
    dest: "{{ sidekick__posthog__install_dir }}"

- name: Rename docker-compose.hobby.yml to docker-compose.yml
  ansible.builtin.copy:
    src: "{{ sidekick__posthog__install_dir }}/docker-compose.hobby.yml"
    dest: "{{ sidekick__posthog__install_dir }}/docker-compose.yml"
    mode: "0644"
    owner: "{{ ansible_user | default('root') }}"
    group: "{{ ansible_user | default('root') }}"
    remote_src: true

##
##
##

- name: Remove caddy from docker-compose.yml using yq (inplace mandatory)
  ansible.builtin.command:
    argv:
      - yq
      - -y
      - -i
      - del(.services.caddy, .volumes."caddy-config", .volumes."caddy-data")
      - "{{ sidekick__posthog__install_dir }}/docker-compose.yml"
  register: yq_result
  changed_when: yq_result.rc == 0

- name: Add env_file to worker
  ansible.builtin.command:
    argv:
      - yq
      - -y
      - -i
      - .services.worker.env_file[0] = "./.env.worker"
      - "{{ sidekick__posthog__install_dir }}/docker-compose.base.yml"
  register: yq_result
  changed_when: yq_result.rc == 0

##
##
##

- name: Check if .env file exists
  ansible.builtin.stat:
    path: "{{ sidekick__posthog__install_dir }}/.env"
  register: env_file

- name: Create .env file from template
  ansible.builtin.template:
    src: .env.j2
    dest: "{{ sidekick__posthog__install_dir }}/.env"
    mode: "0644"
    owner: "{{ ansible_user | default('root') }}"
    group: "{{ ansible_user | default('root') }}"
  when: not env_file.stat.exists

- name: Create .env.worker file from template
  ansible.builtin.template:
    src: .env.worker.j2
    dest: "{{ sidekick__posthog__install_dir }}/.env.worker"
    mode: "0644"
    owner: "{{ ansible_user | default('root') }}"
    group: "{{ ansible_user | default('root') }}"
  when: not env_file.stat.exists
