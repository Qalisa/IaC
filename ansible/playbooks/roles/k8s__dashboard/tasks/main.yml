---
- name: Install service accounts
  kubernetes.core.k8s:
    state: present
    template:
      - path: templates/ns.yml.j2
      - path: templates/admin-account.yml.j2

- name: Add stable chart repo
  kubernetes.core.helm_repository:
    name: kubernetes-dashboard
    repo_url: https://kubernetes.github.io/dashboard/

- name: Install Zero-Trust configuration
  kubernetes.core.k8s:
    state: present
    template:
      - path: templates/caa.yml.j2

- name: Install Dashboard w/ Helm
  kubernetes.core.helm:
    name: kubernetes-dashboard
    chart_ref: kubernetes-dashboard/kubernetes-dashboard
    release_namespace: kubernetes-dashboard
    create_namespace: false
    values:
      app:
        kong:
          enabled: false
        ingress:
          enabled: true
          ingressClassName: "{{ iac__ingress_nginx_class }}"
          annotations:
            nginx.ingress.kubernetes.io/backend-protocol: "HTTPS"
            # when using Cloudflare's proxied DNS record
            nginx.ingress.kubernetes.io/ssl-redirect: "false"
            cert-manager.io/cluster-issuer: "{{ cert_manager__org_ca__name }}"
            #
            external-dns.alpha.kubernetes.io/hostname: "{{ k8s__dashboard__external_hostname }}"
            external-dns.alpha.kubernetes.io/cloudflare-proxied: "true"
            #
            ingress-dashboard/title: Kubernetes Dashboard
            ingress-dashboard/description: Official dashboard to manage a k8s cluster
            ingress-dashboard/logo-url: /assets/images/kubernetes-logo.png
            ingress-dashboard/assume-tls: "true"
            ingress-dashboard/hide: "false"
          useDefaultAnnotations: false
          hosts:
            - "{{ k8s__dashboard__external_hostname }}"
          tls:
            enabled: false

- name: Fix Service
  kubernetes.core.k8s:
    state: present
    template:
      - path: templates/service.yml.j2

#
- name: Save Token
  block:
    - name: Get auth token
      ansible.builtin.command: |
        set -o pipefail
        kubectl get secret admin-user -n kubernetes-dashboard -o jsonpath={".data.token"} | base64 -d
      register: dashboard_token
      changed_when: dashboard_token.rc != 0 # <- Uses the return code to define when the task has changed.
    - name: Make sure destination dir exists
      ansible.builtin.file:
        path: "{{ iac__generated_creds_dir }}"
        state: directory
        mode: "0775"
    - name: Save
      ansible.builtin.copy:
        content: "{{ dashboard_token.stdout }}"
        dest: "{{ iac__generated_creds_dir }}/dashboard-token.serviceaccount.txt"
        mode: "0775"
