---
- name: Install service accounts
  kubernetes.core.k8s:
    template:
      - path: templates/ns.yml.j2
      - path: templates/admin-account.yml.j2

- name: Install Zero-Trust configuration
  tags: [zto-app]
  kubernetes.core.k8s:
    template:
      - path: templates/caa.yml.j2

- name: Add stable chart repo
  kubernetes.core.helm_repository:
    name: kubernetes-dashboard
    repo_url: https://kubernetes.github.io/dashboard/
    force_update: true

- name: Install Dashboard w/ Helm
  kubernetes.core.helm:
    name: kubernetes-dashboard
    chart_ref: kubernetes-dashboard/kubernetes-dashboard
    release_namespace: "{{ k8s__dashboard__namespace }}"
    create_namespace: false
    values:
      kong:
        enabled: true # required since https://github.com/kubernetes/dashboard/pull/9317 wont be merged
      metricsScraper:
        enabled: false
      app:
        ingress:
          enabled: true
          issuer: # done below manually, to stick to habits
            scope: disabled
          ingressClassName: "{{ iac__implicit_ingress_class_name }}"
          annotations:
            #
            external-dns.alpha.kubernetes.io/hostname: "{{ k8s__dashboard__external_hostname }}"
            external-dns.alpha.kubernetes.io/cloudflare-proxied: "true"
            #
            ingress-dashboard/title: Kubernetes Dashboard
            ingress-dashboard/description: Official dashboard to manage a k8s cluster
            ingress-dashboard/logo-url: /assets/images/kubernetes-logo.png
            ingress-dashboard/assume-tls: "true"
            ingress-dashboard/hide: "false"
          useDefaultAnnotations: false
          hosts:
            - "{{ k8s__dashboard__external_hostname }}"
          tls:
            enabled: false

#
- name: Save Token
  block:
    - name: Get auth token
      # use "ansible.builtin.shell" for pipeable commands
      ansible.builtin.shell: |
        set -o pipefail
        kubectl get secret admin-user -n {{ k8s__dashboard__namespace }} -o jsonpath={".data.token"} | base64 -d
      register: dashboard_token
      changed_when: dashboard_token.rc != 0 # <- Uses the return code to define when the task has changed.
    - name: Make sure destination dir exists
      ansible.builtin.file:
        path: "{{ iac__generated_creds_dir }}"
        state: directory
        mode: "0775"
    - name: Save
      ansible.builtin.copy:
        content: "{{ dashboard_token.stdout }}"
        dest: "{{ iac__generated_creds_dir }}/dashboard-token.serviceaccount.txt"
        mode: "0775"
