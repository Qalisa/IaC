---
- name: Add stable chart repo
  kubernetes.core.helm_repository:
    name: christianhuth
    repo_url: https://christianhuth.github.io/helm-charts

- name: Install Zero-Trust configuration
  tags: [zto-app]
  kubernetes.core.k8s:
    state: present
    template:
      - path: templates/caa.yml.j2

- name: Install Skooner w/ Helm
  kubernetes.core.helm:
    name: skooner
    chart_ref: christianhuth/skooner
    release_namespace: skooner
    create_namespace: true
    wait: true
    values:
      clusterRoleBinding:
        clusterRole: "cluster-admin"
      ingress:
        enabled: true
        className: "{{ iac__ingress_nginx_class }}"
        annotations:
          # when using Cloudflare's proxied DNS record
          nginx.ingress.kubernetes.io/ssl-redirect: "false"
          cert-manager.io/cluster-issuer: "{{ cert_manager__org__issuer }}"
          nginx.ingress.kubernetes.io/backend-protocol: "HTTP"
          #
          external-dns.alpha.kubernetes.io/hostname: "{{ k8s__skooner__external_hostname }}"
          external-dns.alpha.kubernetes.io/cloudflare-proxied: "true"
          #
          ingress-dashboard/title: Skooner
          ingress-dashboard/description: Alternative cluster dashboard with live metrics
          ingress-dashboard/logo-url: /favicon.ico
          ingress-dashboard/assume-tls: "true"
          ingress-dashboard/hide: "false"
        hosts:
          - host: "{{ k8s__skooner__external_hostname }}"
            paths:
              - path: "/"
                pathType: ImplementationSpecific

#
- name: Create token
  kubernetes.core.k8s:
    state: present
    template:
      - path: templates/token.yml.j2

#
- name: Save Token
  block:
    - name: Get auth token
      # use "ansible.builtin.shell" for pipeable commands
      ansible.builtin.shell: |
        set -o pipefail
        kubectl get secret skooner-sa -n skooner -o jsonpath={".data.token"} | base64 -d
      register: skooner_token
      changed_when: skooner_token.rc != 0
    - name: Make sure destination dir exists
      ansible.builtin.file:
        path: "{{ iac__generated_creds_dir }}"
        state: directory
        mode: "0775"
    - name: Save
      ansible.builtin.copy:
        content: "{{ skooner_token.stdout }}"
        dest: "{{ iac__generated_creds_dir }}/skooner-token.serviceaccount.txt"
        mode: "0775"
