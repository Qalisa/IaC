---
# required for RWX (https://longhorn.io/docs/1.8.0/deploy/install/#installing-nfsv4-client)
- name: Install NFS client packages (Debian/Ubuntu)
  ansible.builtin.apt:
    name: nfs-common
    state: present
    update_cache: true

- name: Install backup secrets
  kubernetes.core.k8s:
    template:
      - path: templates/ns.yml.j2
      - path: templates/backup.secret.yml.j2

- name: Add stable chart repo
  kubernetes.core.helm_repository:
    name: longhorn
    repo_url: https://charts.longhorn.io
    force_update: true

- name: Install Longhorn w/ Helm
  kubernetes.core.helm:
    name: longhorn
    chart_ref: longhorn/longhorn
    release_namespace: "{{ k8s__longhorn__namespace }}"
    create_namespace: false
    wait: true
    values:
      defaultBackupStore:
        backupTarget: "{{ longhorn__backup_storage__bucket_url }}"
        backupTargetCredentialSecret: "{{ k8s__longhorn__backup_credentials__secret_name }}"
      defaultSettings:
        defaultReplicaCount: 1
      persistence:
        defaultClassReplicaCount: 1
      longhornUI:
        replicas: 1
      csi:
        attacherReplicaCount: 1
        provisionerReplicaCount: 1
        resizerReplicaCount: 1
        snapshotterReplicaCount: 1
      ingress:
        enabled: true
        host: "{{ k8s__longhorn__external_hostname }}"
        annotations:
          #
          external-dns.alpha.kubernetes.io/hostname: "{{ k8s__longhorn__external_hostname }}"
          external-dns.alpha.kubernetes.io/cloudflare-proxied: "true"
          #
          ingress-dashboard/title: Longhorn
          ingress-dashboard/description: Distributed block storage system for Kubernetes
          ingress-dashboard/logo-url: /favicon.ico
          ingress-dashboard/assume-tls: "true"
          ingress-dashboard/hide: "false"

- name: Install Zero-Trust configuration
  tags: [zto-app]
  kubernetes.core.k8s:
    template:
      - path: templates/caa.yml.j2
