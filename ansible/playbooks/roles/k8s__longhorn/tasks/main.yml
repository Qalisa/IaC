---
- name: Add stable chart repo
  kubernetes.core.helm_repository:
    name: longhorn
    repo_url: https://charts.longhorn.io

- name: Install Longhorn w/ Helm
  kubernetes.core.helm:
    name: longhorn
    chart_ref: longhorn/longhorn
    release_namespace: longhorn-system # required to be specifically "longhorn-system" ! (https://artifacthub.io/packages/helm/longhorn/longhorn)
    create_namespace: true
    wait: true
    values:
      defaultSettings:
        defaultReplicaCount: 1
      persistence:
        defaultClassReplicaCount: 1
      longhornUI:
        replicas: 1
      csi:
        attacherReplicaCount: 1
        provisionerReplicaCount: 1
        resizerReplicaCount: 1
        snapshotterReplicaCount: 1
      ingress:
        enabled: true
        host: "{{ k8s__longhorn__external_hostname }}"
        annotations:
          #
          external-dns.alpha.kubernetes.io/hostname: "{{ k8s__longhorn__external_hostname }}"
          external-dns.alpha.kubernetes.io/cloudflare-proxied: "true"
          #
          ingress-dashboard/title: Longhorn
          ingress-dashboard/description: Distributed block storage system for Kubernetes
          ingress-dashboard/logo-url: /favicon.ico
          ingress-dashboard/assume-tls: "true"
          ingress-dashboard/hide: "false"

- name: Install Zero-Trust configuration
  tags: [zto-app]
  kubernetes.core.k8s:
    template:
      - path: templates/caa.yml.j2
