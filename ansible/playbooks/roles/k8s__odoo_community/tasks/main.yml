---
- name: Add stable chart repo
  kubernetes.core.helm_repository:
    name: bitnami
    repo_url: https://charts.bitnami.com/bitnami
    force_update: true

- name: Install Postgres w/ Helm
  kubernetes.core.helm:
    name: "{{ k8s__odoo_community__db__name }}"
    chart_ref: bitnami/postgresql
    release_namespace: "{{ k8s__odoo_community__namespace }}"
    create_namespace: true
    wait: true
    values:
      auth:
        #
        postgresPassword: "{{ k8s__odoo_community__db__config__admin_password }}"
        #
        username: "{{ k8s__odoo_community__db__config__username }}"
        password: "{{ k8s__odoo_community__db__config__password }}"
        #
        database: "{{ k8s__odoo_community__db__config__db_name }}"

- name: Install Odoo w/ Helm
  kubernetes.core.helm:
    name: odoo
    chart_ref: bitnami/odoo
    release_namespace: "{{ k8s__odoo_community__namespace }}"
    create_namespace: false
    wait: true
    values:
      odooSkipInstall: true
      #
      odooEmail: "{{ iac__postmaster_username }}@{{ iac__root_domain }}"
      odooPassword: "{{ iac__postmaster_password }}"
      #
      smtpHost: "{{ docker_mailserver__internal_smtp_server }}"
      smtpPort: "{{ docker_mailserver__internal_smtp_preferred_port }}"
      smtpUser: "{{ iac__donotreply_username }}"
      smtpPassword: "{{ iac__donotreply_password }}"
      #
      postgresql:
        enabled: false
      externalDatabase:
        host: "{{ k8s__odoo_community__db__name }}.{{ k8s__odoo_community__namespace }}.svc.cluster.local"
        user: "{{ k8s__odoo_community__db__config__username }}"
        password: "{{ k8s__odoo_community__db__config__password }}"
        database: "{{ k8s__odoo_community__db__config__db_name }}"
        postgresqlPostgresPassword: "{{ k8s__odoo_community__db__config__admin_password }}"
      #
      service:
        type: ClusterIP
      ingress:
        enabled: true
        hostname: "{{ k8s__odoo_community__extername_hostname }}"
        annotations:
          #
          external-dns.alpha.kubernetes.io/hostname: "{{ k8s__odoo_community__extername_hostname }}"
          external-dns.alpha.kubernetes.io/cloudflare-proxied: "true"
          #
          ingress-dashboard/title: Odoo
          ingress-dashboard/description: All-in-one CRM-like app
          ingress-dashboard/logo-url: /favicon.ico
          ingress-dashboard/assume-tls: "true"
          ingress-dashboard/hide: "false"
