---
- name: Search for pod exact name
  kubernetes.core.k8s_info:
    kind: Pod
    label_selectors:
      - app.kubernetes.io/name = argocd-server
  register: pod_name_search

##
## Interract with API, register repo and creds
##
- name: Read keys as raw bytes
  ansible.builtin.slurp:
    src: "{{ argocd_admin_pwd_path }}"
  register: admin_pwd
- name: Get ArgoCD authentication token
  ansible.builtin.uri:
    url: "{{ argocd_api_url_part }}/session"
    validate_certs: false
    method: POST
    body_format: json
    body:
      username: "admin"
      password: "{{ admin_pwd.content | b64decode }}"
  register: argocd_auth_response

- name: Add Github repository creds to ArgoCD
  ansible.builtin.uri:
    url: "{{ argocd_api_url_part }}/repocreds"
    validate_certs: false
    method: POST
    headers:
      Authorization: "Bearer {{ argocd_auth_response.json.token }}"
      Content-Type: "application/json"
    body_format: json
    body:
      type: "git"
      url: "{{ github_org_url }}"
      githubAppID: "{{ argocd_github_app_app_id }}"
      githubAppInstallationID: "{{ argocd_github_app_installation_id }}"
      githubAppPrivateKey: "{{ argocd_github_app_priv_key }}"

#
#
#

- name: Install ArgoCD notifications for Github
  block:
    # Download and apply manifest
    - name: Apply catalog
      ansible.builtin.command: |
        kubectl apply -n argocd -f https://raw.githubusercontent.com/argoproj/argo-cd/stable/notifications_catalog/install.yaml
    # https://argo-cd.readthedocs.io/en/latest/operator-manual/notifications/
    # https://argo-cd.readthedocs.io/en/latest/operator-manual/notifications/catalog/
    - name: Apply configuration and github secret (Controller wide, eg applies to all apps)
      kubernetes.core.k8s:
        state: present
        template:
          - path: "templates/notifications/controller/secret.yml.j2"
          - path: "templates/notifications/controller/config.yml.j2"

#
#
#

- name: Install App of apps repository to ArgoCD
  kubernetes.core.k8s:
    state: present
    template:
      - path: templates/app-of-apps.yml.j2
