---
- name: Install argocd ingress + argocd config
  kubernetes.core.k8s:
    state: present
    template:
      - path: "templates/ingress.yml.j2"
      - path: "templates/argocd-cm.yml.j2"
      - path: "templates/argocd-cmd-params-cm.yml.j2"
##
##
##

- name: Wait for pod to become ready
  ansible.builtin.command: "kubectl wait --namespace=argocd -l app.kubernetes.io/name=argocd-server --for=condition=Ready pods --timeout=120s"
  register: pods_ready
  changed_when: pods_ready.rc != 0

- name: Search for pod exact name
  kubernetes.core.k8s_info:
    kind: Pod
    label_selectors:
      - app.kubernetes.io/name = argocd-server
  register: pod_name_search

- name: Argocd autogenerated initial password
  kubernetes.core.k8s_exec:
    namespace: argocd
    pod: "{{ pod_name_search.resources[0].metadata.name }}"
    command: argocd admin initial-password -n argocd
  register: argocd_init_admin_pwd

#
- name: Save password
  block:
    - name: Make sure destination dir exists
      ansible.builtin.file:
        path: "{{ generated_creds_dir }}"
        state: directory
    - name: Save
      ansible.builtin.copy:
        content: "{{ argocd_init_admin_pwd.stdout_lines[0] }}"
        dest: "{{ argocd_admin_pwd_path }}"
